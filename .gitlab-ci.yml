# =============================================================================
# GitLab CI/CD Pipeline para Iptables Secure Manager
# Proyecto Educativo de Ciberseguridad
# =============================================================================

stages:
  - validate
  - test
  - security
  - deploy

variables:
  PYTHON_VERSION: "3.9"
  PROJECT_NAME: "iptables-secure-manager"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - .pytest_cache/
  key: ${CI_COMMIT_REF_SLUG}

# =============================================================================
# VALIDACIÓN DE CÓDIGO
# =============================================================================
validate:python:
  stage: validate
  image: python:${PYTHON_VERSION}
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install flake8 pylint
  script:
    - echo "Validando sintaxis de Python..."
    - flake8 src/ --max-line-length=100 --ignore=E501,W503 || true
    - pylint src/ --disable=C0114,C0115,C0116 || true
  allow_failure: true

validate:structure:
  stage: validate
  image: alpine:latest
  script:
    - 'echo "Validando estructura del proyecto..."'
    - 'test -f src/Iptables.py || (echo "ERROR: No existe src/Iptables.py" && exit 1)'
    - 'test -f README.md || (echo "ERROR: No existe README.md" && exit 1)'
    - 'test -d docs/ || (echo "ERROR: No existe directorio docs/" && exit 1)'
    - 'test -d tests/ || (echo "ERROR: No existe directorio tests/" && exit 1)'
    - 'echo "✅ Estructura validada correctamente"'

# =============================================================================
# TESTING AUTOMATIZADO
# =============================================================================
test:unit:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install pytest pytest-cov
  script:
    - echo "Ejecutando pruebas unitarias..."
    - if [ -d "tests" ]; then
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=xml || true;
      else
        echo "⚠️ No hay tests unitarios implementados";
      fi
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 week

test:integration:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - python --version
    - pip install --upgrade pip
  script:
    - echo "Ejecutando pruebas de integración..."
    - |
      python -c "
      import sys
      sys.path.append('src')
      try:
          from Iptables import validar_ip, validar_puerto
          print('✅ Importación exitosa')

          # Test validación IP
          assert validar_ip('192.168.1.1') == True
          assert validar_ip('256.256.256.256') == False
          print('✅ Validación IP funciona')

          # Test validación puerto
          assert validar_puerto('80') == True
          assert validar_puerto('65536') == False
          print('✅ Validación puerto funciona')

          print('✅ Todas las pruebas de integración pasaron')
      except Exception as e:
          print(f'❌ Error: {e}')
          sys.exit(1)
      "

# =============================================================================
# ANÁLISIS DE SEGURIDAD
# =============================================================================
security:code:
  stage: security
  image: python:${PYTHON_VERSION}
  before_script:
    - pip install --upgrade pip
    - pip install bandit safety
  script:
    - echo "Análisis de seguridad del código..."
    - bandit -r src/ -f json -o bandit-report.json || true
    - bandit -r src/ --severity-level medium
    - safety check || true
  artifacts:
    paths:
      - bandit-report.json
    expire_in: 1 week
  allow_failure: true

# =============================================================================
# DESPLIEGUE Y DOCUMENTACIÓN
# =============================================================================
deploy:docs:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Generando documentación..."
    - echo "Documentación disponible en docs/"
    - ls -la docs/
  artifacts:
    paths:
      - docs/
    expire_in: 1 week
  only:
    - main
    - master

# =============================================================================
# LIMPIEZA
# =============================================================================
cleanup:
  stage: .post
  image: alpine:latest
  script:
    - echo "Limpiando archivos temporales..."
    - find . -name "*.pyc" -delete
    - find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
    - echo "✅ Limpieza completada"
  when: always

# =============================================================================
# REGLAS DE EJECUCIÓN
# =============================================================================
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
